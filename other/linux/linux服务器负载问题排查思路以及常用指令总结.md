## linux服务器负载问题排查思路以及常用指令总结

服务器的性能主要看四大件：cpu、内存、磁盘、网络。下面是常用的排查思路。

## CPU和内存问题

### top命令
top命令能够实时监控系统的运行状态，并且按照CPU、内存和执行时间进行排序，
同时top命令还可以通过交互式命令进行设定显示，通过top命令可以查看即时活
跃的进程。  
````
top - 17:24:42 up  9:10,  1 user,  load average: 1.50, 1.50, 1.56
Tasks: 274 total,   1 running, 219 sleeping,   0 stopped,   1 zombie
%Cpu(s):  3.2 us,  3.1 sy,  0.0 ni, 93.4 id,  0.1 wa,  0.0 hi,  0.2 si,  0.0 st
KiB Mem : 16294156 total,  2769376 free,  5753276 used,  7771504 buff/cache
KiB Swap:  4194300 total,  4194300 free,        0 used.  9227048 avail Mem 

  PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                         
  623 root     -51   0       0      0      0 D  11.6  0.0  25:27.38 irq/136-SYNA308                                 
 1130 root      20   0  682972 238292 178304 S   5.0  1.5  34:02.22 Xorg                                            
 4163 liz       20   0 3451648 155092  94756 S   4.0  1.0  26:33.41 kwin_x11                                        
 8084 liz       20   0 3402536 320632  53192 S   3.7  2.0  32:08.25 WeChat.exe                                      
 8090 liz       20   0    9992   7192   1828 S   3.0  0.0  17:08.10 wineserver.real                                 
18503 liz       20   0  648956  71024  35452 S   3.0  0.4   0:24.04 deepin-terminal                                 
 8912 liz       20   0 7502660 1.452g 146036 S   2.7  9.3  36:00.50 java                                            
 8074 liz       20   0 1241784 471808 273892 S   2.0  2.9  37:12.16 dingtalk                                        
18542 liz       20   0  511728  38300  10644 S   0.7  0.2   1:19.92 docker-compose                                  
23773 liz       20   0 1060704 286388 110568 S   0.7  1.8   1:25.11 chrome                                          
25793 liz       20   0   46812   3752   3024 R   0.7  0.0   0:02.45 top                                             
 3171 liz       20   0 2101792  23552  16524 S   0.3  0.1   0:50.57 startdde                                        
 4200 liz       20   0 2244084  52888  32340 S   0.3  0.3   1:01.10 dde-session-dae                                 
18441 liz       20   0  750956 108936  78260 S   0.3  0.7   2:17.41 dde-file-manage                                 
18813 deepin-+  20   0   25252   2916   1812 S   0.3  0.0   0:27.21 redis-server                                    
19712 liz       20   0 3639568 332556  41980 S   0.3  2.0   1:01.00 Navicat.exe                                     
23525 liz       20   0  929804 270044 153808 S   0.3  1.7   0:44.78 chrome                                          
25179 liz       20   0 1626084 217176  86820 S   0.3  1.3   5:04.57 _Postman                                        
25391 root      20   0       0      0      0 I   0.3  0.0   0:00.83 kworker/u8:2                                    
    1 root      20   0  204880   7132   5184 S   0.0  0.0   0:04.24 systemd                                         
    2 root      20   0       0      0      0 S   0.0  0.0   0:00.02 kthreadd                                        
    4 root       0 -20       0      0      0 I   0.0  0.0   0:00.00 kworker/0:0H                                    
    6 root       0 -20       0      0      0 I   0.0  0.0   0:00.00 mm_percpu_wq                                    
    7 root      20   0       0      0      0 S   0.0  0.0   0:02.24 ksoftirqd/0                                     
    8 root      20   0       0      0      0 I   0.0  0.0   0:32.35 rcu_sched                                       
    9 root      20   0       0      0      0 I   0.0  0.0   0:00.00 rcu_bh                                          
   10 root      rt   0       0      0      0 S   0.0  0.0   0:00.03 migration/0                                     
   11 root      rt   0       0      0      0 S   0.0  0.0   0:00.06 watchdog/0                                      
   12 root      20   0       0      0      0 S   0.0  0.0   0:00.00 cpuhp/0                                         
````
那么我们来一一分析里面每个值的含义  


|           参数                  |                含义                |
| :----------------------------: | :--------------------------------: |
| 17:24:42                       |系统时间                             |
| up  9:10                       |系统运行的时间                        |
| user                           |系统当前登录的用户数                   |
| load average: 1.50, 1.50, 1.56 |过去一分钟五分钟十五分钟系统负载         |
| ----                           |----                                |
| Tasks                          |任务进程数                            |
| total                          |总进程数                              |
| running                        |正在运行的进程数                       |
| sleeping                       |休眠状态进程数                         |
| stopped                        |停止进程数                            |
| ----                           |----                                 |
| %us                            |用户进程消耗的CPU时间百分比               |
| %sy                            |系统进程消耗的CPU时间百分比               |
| %ni	                         |运行正常进程消耗的CPU时间百分比            |
| %id                            |CPU空闲状态的时间百分比                  |
| %wa                            |I/O 等待所占 CPU 时间百分比              |
| %hi	                         |硬中断（Hardware IRQ）占用CPU的百分比     |
| %si	                         |软中断（Software Interrupts）占用CPU的百分比|
| %st	                         |在内存紧张环境下，pagein 强制对不同的页面进行的 steal 操作|
| ----                           |----                                 |
| Mem total                      |物理内存总量                            |
| Mem used                       |使用中的内存总量                         |
| Mem free                       |空闲内存总量                            |
| Mem buffers                    |缓存的内存量                            |
| ----                           |----                                 |
| PID                            |进程id                                |
| USER                           |进程所有者                             |
| PR                             |进程优先级                             |
| NI                             |nice值。负值表示高优先级，正值表示低优先级   |
| VIRT                           |进程使用的虚拟内存总量，单位kb。VIRT=SWAP+RES|
| RES                            |进程使用的、未被换出的物理内存大小，单位kb。RES=CODE+DATA|
| SHR                            |共享内存大小，单位kb                    |
| S                              |进程状态。D=不可中断的睡眠状态 R=运行 S=睡眠 T=跟踪/停止 Z=僵尸进程|
| %CPU                           |次更新到现在的CPU时间占用百分比          |
| %MEM                           |进程使用的物理内存百分比                 |
| TIME+                          |进程使用的CPU时间总计，单位1/100秒       |
| COMMAND                        |进程名称（命令名/命令行）               |

下面是几个常用的交互操作：

- 展开CPU  
在top交互界面直接按键盘的数字1。  
这里还是要强调一下，%cpu的值是跟内核数成正比的，如8核cpu的%cpu最大可以800%。    
- 显示线程    
在top交互界面按ctrl+h显示线程，再按一次关闭显示。  
- 增加或删除显示列  
在top交互界面按h进入，输入想显示的列的首字母如n，退出直接回车。  
- 排序  
Cpu ： 在top交互界面按shift+p。  
Mem ：在top交互界面按shift+m。  
Time ：在top交互界面按shift+t。  
- 显示程序名  
在top交互界面按c。  
- 监控线程下的进程  
在命令行输入top -H -p pid，其中pid为进程id，进入界面后显示的PID为线程ID；或者使用命
令top -H -p pid进入界面之后在按shift+h来显示线程。     


下面是几个重点观察的指标  
**%Cpu(s): 5.1 us, 3.4 sy, 0.0 wa**  
>这里可以非常直观的看到当前cpu的负载情况，us用户cpu占用时间，sy是系统调用cpu占用时间，wa是
>cpu等待io的时间，前面两个比较直观，但是第三个其实也很重要，如果wa很高，那么你就该重点关注下磁
>盘的负载了，尤其是像mysql这种服务器。

**load average: 0.08, 0.26, 0.19**  
>cpu任务队列的负载，这个队列包括正在运行的任务和等待运行的任务，三个数字分别是1分钟、5分钟和15分
>钟的平均值。这个和cpu占用率一般是正相关的，反应的是用户代码，如果超过了内核数，表示系统已经过载。
>也就是说如果你是8核，那么这个数字小于等于8的负载都是没问题的，我看网上的建议一般这个值不要超过
>ncpu*2-2为好。

**KiB Mem : 985856 total, 81736 free, 646360 used, 257760 buff/cache**
>内存占用情况，total总内存，free空余内存， used已经分配内存，buff/cache块设备和缓冲区占用的
>内存，因为Linux的内存分配，如果有剩余内存，他就会将内存用于cache，这样可以较少磁盘的读写提高
>效率，如果有应用申请内存，buff/cache这部分内存也是可用的，所以正真的剩余内存应该是
>free+buff/cache

### vmstat命令  

vmstat 可以对操作系统的内存信息、进程状态、CPU 活动、磁盘等信息进行监控，不足之处是无法对某个进程
进行深入分析。
````
$  vmstat 2 3 -S M
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 0  0      0   8234    747   3930    0    0   194   102  353 1307  5  1 93  0  0
 0  0      0   8254    747   3910    0    0     0     0 1165 4908  1  1 98  0  0
 1  0      0   8255    747   3910    0    0     0     0 1053 3867  1  1 98  0  0

````
2表示每2秒取样一次，3表示取数3次，-S表示单位，可选有 k 、K 、m 、M。

- procs  
R表示等待运行和等待CPU时间片的进程数，这个值如果长期大于系统CPU个数，说明CPU不足，需要增加CPU
B表示在等待资源的进程数，比如正在等待I/O或者交换内存等。  
- memory  
swpd 表示切换到内存交换区的内存大小（单位KB）,通俗讲就是虚拟内存的大小。如果swap值不为0或者比较
大，只要si,so的值长期为0，这种情况一般属于正常的情况  
free 表示当前空闲的物理内存 （单位KB）  
buff 列表示buffers cached内存大小，也就是缓存区大小，一般对块设备的读写才需要缓冲。  
cache 列表示page cached的内存大小，也就是缓存大小，一般作为文件系统进行缓冲，频繁访问的文件
都会被缓存，如果cache值非常大说明缓存文件较多，如果此时io中的bi比较小，说明文件系统效率比较好。  
- swap  
si 列表示由磁盘调入内存，也就是内存进入内存交换区的内存大小。  
so 列表示由内存进入磁盘，也就是内存交换区进入内存的内存大小。  
一般情况，si、so的值都为0，如果si、so的值长期不为0，则说明系统内存不足，则需要增加系统内存。  
- io   
bi 列表表示由块设备读入数据的总量，既读磁盘，单位kb/s。  
bo 列表示写到快设备数据的总量，既写磁盘，单位kb/s。  
如果 bi+bo 值过大，且 wa 值较大，则表示系统磁盘 IO 瓶颈。  
- system  
in 列表示某一时刻时间间隔内观测到的每秒设备中断数。  
cs 列表示每秒产生的上下文切换次数。  
这两个值越大，则由内核消耗的CPU就越多。  
- cpu  
us 列表示用户进程消耗的CPU时间百分比，us值越高，说明用户进程消耗cpu时间越多，如果长期大于50%，
则需要考虑优化程序或算法。  
sy 列表示系统内核进程消耗的cpu时间百分比，一般来说us+sy应该小于80%，如果大于80%，说明可能处
cpu瓶颈。  
id 列表示cpu处在空闲状态的百分比。  
wa 列表示IP等待说占的cpu时间百分比，wa值越高，说明I/O等待越严重，根据经验wa的参考值为20%，如果
超过20%，说明I/O等待严重，引起I/O等待的原因可能是磁盘大量随机读写造成的，也可能是磁盘造成的。

### free命令

free命令是监控linux内存使用最常用的命令，参数[-m]表示m为单位查看内存的使用情况（默认kb）  
````
$ free -m
              total        used        free      shared  buff/cache   available
Mem:          15912        5389        3914        1042        6608        9163
Swap:          4095           0        4095
````
- Mem:物理内存大小  
- total:总计物理内存的大小  
- used:已使用的大小  
- free:可用的大小  
- shared:多个进程共享的内存的总额  
- buffers:缓冲区内存总量  
- cached:交换缓存区内存总量   
- Swap:交换缓冲区内存总量  

## 磁盘问题

磁盘问题在mysql服务器中非常常见，很多时候mysql服务器的CPU不高但是却出现慢查询日志飙升，就是因为
磁盘出现了瓶颈。还有mysql的备份策略，如果没有监控磁盘空间，可能出现磁盘满了服务不可用的现象。  

### iostat命令   TODO

### iotop命令   TODO

### du和df命令

主要通过这两个命令看系统的磁盘占用率和文件夹大小，有时候日志文件不清理会导致磁盘用满等情况。  

- du  
````
用法： df -h 查看磁盘占用情况
````
- df  
````
用法： du -sh 查看当前目录 容量
````

**典型问题**  
mysql负载大时，很多时候磁盘先到了瓶颈，大量个请求超时，cpu负载却不高，如果mysql服务器异常，建
议重点看下磁盘。



































## 参考  
【引用】https://cloud.tencent.com/developer/article/1378739  

