## 分析了解pgsql中的索引  

### 前言

pgsql中索引的支持类型好像还是蛮多的，一一来分析下  

### 索引

PostgreSQL提供了多种索引类型： B-tree、Hash、GiST、SP-GiST 、GIN 和 BRIN。每一种索引类型使用了 一种不同的算法来适应不同类型的查询。

#### B-tree

B-tree可以在可排序数据上的处理等值和范围查询。  
例如下面的集中场景:  
````
<
<=
=
>=
>

````

##### 实现

pgsql中B-tree的实现是根据《Effiicient Locking for Concurrent Operations on B-Trees》论文设计实现的。  
Lehman和Yao的论文中，修改了B树的结构，不管是内部节点还是叶子节点，都有一个指针指向兄弟节点。同时还引入了“High Key”（下述HK）用于描述当前子节点的最大值。  

![](https://img2020.cnblogs.com/blog/1237626/202004/1237626-20200429090003097-1404023179.png)

其中的k1就代表一个HK,其值是p0以及p0子节点的最大值。HK并不作为索引结构中的一个元组，只是标记了一个最大的范围。同理，对于上述的2n个节点，每个节点都存在一个指针指向右兄弟节点，Pi的子节点取值范围为（Ki-1，Ki]。  

然后来了解下：表和元组的组织方式  
PostgreSQL的索引结构，也是按照这种方式进行存储的。  

![](https://img2020.cnblogs.com/blog/1237626/202004/1237626-20200429093159100-190402728.png)

PageHeaderDate:是长度为20字节的页头数据，包括该文件块的一般信息，如：  

- 空闲空间的起始和结束位置  
- Special space的开始位置  
- 项指针的开始位置  
- 标志信息，如是否存在空闲项指针、是否所有的元组都可见  


Freespase是指未分配的空间（空闲空间）  

新插入的元组及其对应的Linp元素都会从Freespase空间来分配，Linp从Freespase头部开始分配，新元组（tuple）是从尾部开始分配。而PostgreSQL的索引结构，也是按照上述页面结构进行存储的。  

Special space 是特殊空间：  

用于存放与索引相关的特定函数。由于索引文件的文件块结构和普通的文件的相同，因此Special space在不同表文件块中并没有使用，
其内容被置为空。


![](https://img2020.cnblogs.com/blog/1237626/202004/1237626-20200429221737736-575274913.png)

图中的`itup是`排好序的索引元组，`itup1,itup2,itup3`。它们是有序的。在`page header`后结构之后，是`linp1,linp2`它们存储的是元组在业内的实际位置，通过`linp`可以快速的访问到索引元组。  

根据b-tree，每层的非最右节点需要一个最大关键值（`High Key`），通过它给出该节点索引关键字的范围。如果要插入的关键字大于`High Key`，就需要移动右边的节点，来寻找合适的插入点。  

注意：`linp0`是`page header`中的内容，在这里只是为了描述方便将他拎出来了，在填充页面过程中，`linp0`是没有被赋值的，当页面填充完毕之后，根据情况进行不同的操作。也就是下文中当前节点，位置不同，进行的操作。  


所以根据当前节点的位置有两种的调整方式：  
1、在最右边  
2、不在最右边    

##### 如果该节点不是最右节点

![](https://img2020.cnblogs.com/blog/1237626/202004/1237626-20200430092157575-1379457987.png)

- 首先将`itup3`复制到该节点的右兄弟节点中，然后将`linp0`指向`itup3`（页面中的`High Key`）。  
- 然后去掉`linp3`。也就是使用`linp0`指向页面的`High Key`。由于`High Key`（linp0）只是作为一个索引节点中键值的范围，并不指向实际的元组（itup3），所以去掉指向`itup3`的`linp3`。

##### 如果该节点是最右节点

![](https://img2020.cnblogs.com/blog/1237626/202004/1237626-20200429221737736-575274913.png)

由于最有节点不需要`High Key`，所以`linp0`不需要保存`High Key`，将所有的`linp`递减一个位置，`linp3`同样不需要了。  

每个节点都有一个指针指向右侧的兄弟，pgsql的实现使用了两个指针，分别指向左右的兄弟节点。  

PostgreSQL所实现的BTree索引组织结构如下图：

![](https://img2020.cnblogs.com/blog/1237626/202004/1237626-20200430112315859-2081271983.png)

上图虚线上方的表示索引结构，虚线下方的为表元组。在叶子节点层，索引节点的指针指向表元组。每一个索引节点对应一个索引的页面，内部节点（包括根结点）与叶子节点的内部结构是一致的。
不同的是内部节点指向下一层的指针是指向索引节点的，而叶子节点指向的是物理存储的某个位置。
 
 

### 参考

【深入浅出PostgreSQL B-Tree索引结构】https://yq.aliyun.com/articles/53701   
【PostgreSQL内核分析——BTree索引】https://www.cnblogs.com/scu-cjx/p/9960483.html    